<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicitudes de Factoraje - TekProvider</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/main.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="wrapper">
        <!-- Sidebar -->
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-building logo"></i>
                <h3>TekProvider</h3>
            </div>
            <ul class="sidebar-nav">
                <li class="nav-item">
                    <a href="dashboard.html" class="nav-link">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="facturas.html" class="nav-link">
                        <i class="fas fa-file-invoice"></i>
                        <span>Mis Facturas</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="solicitudes.html" class="nav-link active">
                        <i class="fas fa-paper-plane"></i>
                        <span>Solicitudes de Factoraje</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="estatus.html" class="nav-link">
                        <i class="fas fa-chart-line"></i>
                        <span>Estatus</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="reportes.html" class="nav-link">
                        <i class="fas fa-chart-bar"></i>
                        <span>Reportes</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="tickets.html" class="nav-link">
                        <i class="fas fa-headset"></i>
                        <span>Mesa de Ayuda</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="perfil.html" class="nav-link">
                        <i class="fas fa-user"></i>
                        <span>Mi Perfil</span>
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <div id="content" class="content">
            <!-- Top Navigation -->
            <nav class="navbar navbar-expand-lg navbar-light">
                <div class="container-fluid">
                    <button type="button" id="sidebarToggle" class="btn btn-outline-primary">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="navbar-nav ms-auto">
                        <div class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user-circle"></i>
                                Admin
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="perfil.html">Mi Perfil</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="logout()">Cerrar Sesión</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- Main Content Area -->
            <div class="main-content">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-12">
                            <div class="page-header">
                                <h1>Solicitudes de Factoraje</h1>
                                <p>Facturas seleccionadas para envío a factoraje</p>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <button class="btn btn-info me-2" onclick="showAdvancedQuotationModal()">
                                <i class="fas fa-calculator"></i> Cotizador Avanzado
                            </button>
                            <button class="btn btn-primary" onclick="submitRequest()">
                                <i class="fas fa-paper-plane"></i> Enviar Solicitud
                            </button>
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped" id="solicitudesTable">
                                    <thead>
                                        <tr>
                                            <th>Folio</th>
                                            <th>Cliente</th>
                                            <th>Monto</th>
                                            <th>Fecha Emisión</th>
                                            <th>Días de Pago</th>
                                            <th>Cedente</th>
                                            <th>Pagador</th>
                                            <th>Tipo</th>
                                            <th>Recurso</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="solicitudesTableBody">
                                    </tbody>
                                </table>
                            </div>
                            <div id="emptyState" class="text-center py-5" style="display: none;">
                                <i class="fas fa-file-invoice fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No hay facturas seleccionadas</h5>
                                <p class="text-muted">Selecciona facturas desde la sección "Mis Facturas" para enviarlas a factoraje</p>
                                <a href="facturas.html" class="btn btn-primary">
                                    <i class="fas fa-file-invoice"></i> Ir a Mis Facturas
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Quotation Modal -->
    <div class="modal fade" id="advancedQuotationModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header bg-gradient-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-calculator me-2"></i>
                        Cotizador Avanzado de Factoraje
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- Left Panel - Invoice Selection -->
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0"><i class="fas fa-list-check me-2"></i>Seleccionar Facturas</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <input type="text" id="searchInvoices" class="form-control" placeholder="Buscar facturas...">
                                    </div>
                                    <div id="invoiceSelectionGrid" style="max-height: 400px; overflow-y: auto;">
                                        <!-- Invoice grid will be populated here -->
                                    </div>
                                    <div class="mt-3 p-3 bg-light rounded">
                                        <div class="row text-center">
                                            <div class="col-6">
                                                <h6 class="text-primary mb-0" id="selectedInvoicesCount">0</h6>
                                                <small class="text-muted">Facturas</small>
                                            </div>
                                            <div class="col-6">
                                                <h6 class="text-success mb-0" id="selectedInvoicesTotal">$0</h6>
                                                <small class="text-muted">Total</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Center Panel - Quotation Parameters -->
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0"><i class="fas fa-sliders-h me-2"></i>Parámetros de Cotización</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Plazo (días)</label>
                                        <input type="number" id="quotePlazo" class="form-control" value="30" oninput="calculateAdvancedQuotation()">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">% Adelanto</label>
                                        <input type="number" id="quoteAdelanto" class="form-control" value="80" step="0.1" oninput="calculateAdvancedQuotation()">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">% Retención</label>
                                        <input type="number" id="quoteRetencion" class="form-control" value="15" step="0.1" oninput="calculateAdvancedQuotation()">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Tasa Anual (%)</label>
                                        <input type="number" id="quoteTasa" class="form-control" value="24" step="0.1" oninput="calculateAdvancedQuotation()">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">% Comisión</label>
                                        <input type="number" id="quoteComision" class="form-control" value="3" step="0.1" oninput="calculateAdvancedQuotation()">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Cedente</label>
                                        <select id="quoteCedente" class="form-select">
                                            <option value="Servicios Demo S.A.">Servicios Demo S.A.</option>
                                            <option value="Nestlé México">Nestlé México</option>
                                            <option value="Coca Cola">Coca Cola</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Pagador</label>
                                        <select id="quotePagador" class="form-select">
                                            <option value="Servicios Demo S.A.">Servicios Demo S.A.</option>
                                            <option value="Nestlé México">Nestlé México</option>
                                            <option value="Coca Cola">Coca Cola</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Panel - Results and Payment Schedule -->
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>Resumen de Cotización</h6>
                                </div>
                                <div class="card-body">
                                    <div id="quotationSummary">
                                        <div class="row mb-3">
                                            <div class="col-12">
                                                <div class="bg-primary text-white p-3 rounded text-center">
                                                    <h4 class="mb-0" id="summaryTotal">$0</h4>
                                                    <small>Monto Total</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-6">
                                                <div class="bg-success text-white p-2 rounded text-center">
                                                    <h6 class="mb-0" id="summaryAdelanto">$0</h6>
                                                    <small>Adelanto</small>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="bg-warning text-dark p-2 rounded text-center">
                                                    <h6 class="mb-0" id="summaryRetencion">$0</h6>
                                                    <small>Retención</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-6">
                                                <div class="bg-danger text-white p-2 rounded text-center">
                                                    <h6 class="mb-0" id="summaryComision">$0</h6>
                                                    <small>Comisión</small>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="bg-info text-white p-2 rounded text-center">
                                                    <h6 class="mb-0" id="summaryCAT">0%</h6>
                                                    <small>CAT</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-12">
                                                <div class="bg-dark text-white p-3 rounded text-center">
                                                    <h4 class="mb-0" id="summaryNeto">$0</h4>
                                                    <small>Neto a Recibir</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <hr>

                                    <h6><i class="fas fa-calendar-alt me-2"></i>Tabla de Pagos</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Pago</th>
                                                    <th>Fecha</th>
                                                    <th>Monto</th>
                                                </tr>
                                            </thead>
                                            <tbody id="paymentScheduleTable">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-danger" onclick="downloadQuotationPDF()">
                        <i class="fas fa-file-pdf me-2"></i>Descargar PDF
                    </button>
                    <button type="button" class="btn btn-primary" onclick="applyAdvancedQuotation()">
                        <i class="fas fa-check me-2"></i>Aplicar Cotización
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/main.js"></script>
    <script>
        // Available invoices for factoring (from localStorage or default)
        let availableInvoices = [
            {id: 1, folio: 'F001', cliente: 'Nestlé México', monto: 125000, fechaEmision: '2024-01-15', fechaVencimiento: '2024-02-15', estatus: 'Emitida', tipoOperacion: 'Proveedor', recurso: 'Con Recurso', cedente: 'Servicios Demo S.A.', pagador: 'Nestlé México'},
            {id: 3, folio: 'F003', cliente: 'Walmart', monto: 245000, fechaEmision: '2024-01-17', fechaVencimiento: '2024-02-17', estatus: 'Emitida', tipoOperacion: 'Proveedor', recurso: 'Con Recurso', cedente: 'Servicios Demo S.A.', pagador: 'Walmart'},
            {id: 5, folio: 'F005', cliente: 'Liverpool', monto: 156000, fechaEmision: '2024-01-19', fechaVencimiento: '2024-02-19', estatus: 'Emitida', tipoOperacion: 'Proveedor', recurso: 'Con Recurso', cedente: 'Servicios Demo S.A.', pagador: 'Liverpool'},
            {id: 7, folio: 'F007', cliente: 'Chedraui', monto: 123000, fechaEmision: '2024-01-21', fechaVencimiento: '2024-02-21', estatus: 'Emitida', tipoOperacion: 'Proveedor', recurso: 'Con Recurso', cedente: 'Servicios Demo S.A.', pagador: 'Chedraui'},
            {id: 8, folio: 'F008', cliente: 'Oxxo', monto: 45000, fechaEmision: '2024-01-22', fechaVencimiento: '2024-02-22', estatus: 'Emitida', tipoOperacion: 'Cliente', recurso: 'Sin Recurso', cedente: 'Oxxo', pagador: 'Servicios Demo S.A.'},
            {id: 10, folio: 'F010', cliente: 'Farmacias Guadalajara', monto: 89000, fechaEmision: '2024-01-24', fechaVencimiento: '2024-02-24', estatus: 'Emitida', tipoOperacion: 'Cliente', recurso: 'Sin Recurso', cedente: 'Farmacias Guadalajara', pagador: 'Servicios Demo S.A.'}
        ];

        let selectedInvoicesForQuote = [];

        function calculateDaysToPayment(fechaVencimiento) {
            const today = new Date();
            const dueDate = new Date(fechaVencimiento);
            const diffTime = dueDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        function loadSelectedInvoices() {
            const selectedIds = JSON.parse(localStorage.getItem('selectedInvoices') || '[]');
            const tbody = document.getElementById('solicitudesTableBody');
            const emptyState = document.getElementById('emptyState');
            
            tbody.innerHTML = '';
            
            if (selectedIds.length === 0) {
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            selectedIds.forEach(id => {
                const factura = availableInvoices.find(f => f.id == id);
                if (factura) {
                    const row = document.createElement('tr');
                    const diasPago = calculateDaysToPayment(factura.fechaVencimiento);
                    
                    row.innerHTML = `
                        <td>${factura.folio}</td>
                        <td>${factura.cliente}</td>
                        <td>$${factura.monto.toLocaleString()}</td>
                        <td>${factura.fechaEmision}</td>
                        <td>
                            <span class="badge ${diasPago < 0 ? 'bg-danger' : diasPago < 7 ? 'bg-warning' : 'bg-success'}">
                                ${diasPago} días
                            </span>
                        </td>
                        <td>${factura.cedente}</td>
                        <td>${factura.pagador}</td>
                        <td><span class="badge ${factura.tipoOperacion === 'Proveedor' ? 'bg-primary' : 'bg-info'}">${factura.tipoOperacion}</span></td>
                        <td><span class="badge ${factura.recurso === 'Con Recurso' ? 'bg-warning' : 'bg-success'}">${factura.recurso}</span></td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="removeFromRequest(${factura.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                }
            });
        }

        function showAdvancedQuotationModal() {
            populateInvoiceGrid();
            const modal = new bootstrap.Modal(document.getElementById('advancedQuotationModal'));
            modal.show();
        }

        function populateInvoiceGrid() {
            const grid = document.getElementById('invoiceSelectionGrid');
            grid.innerHTML = '';

            availableInvoices.forEach(invoice => {
                const isSelected = selectedInvoicesForQuote.includes(invoice.id);
                const card = document.createElement('div');
                card.className = `card mb-2 cursor-pointer ${isSelected ? 'border-primary bg-primary bg-opacity-10' : ''}`;
                card.onclick = () => toggleInvoiceSelection(invoice.id);
                
                card.innerHTML = `
                    <div class="card-body p-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">${invoice.folio}</h6>
                                <small class="text-muted">${invoice.cliente}</small>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold">$${invoice.monto.toLocaleString()}</div>
                                <input type="checkbox" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation()">
                            </div>
                        </div>
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }

        function toggleInvoiceSelection(invoiceId) {
            const index = selectedInvoicesForQuote.indexOf(invoiceId);
            if (index > -1) {
                selectedInvoicesForQuote.splice(index, 1);
            } else {
                selectedInvoicesForQuote.push(invoiceId);
            }
            populateInvoiceGrid();
            updateSelectionSummary();
            calculateAdvancedQuotation();
        }

        function updateSelectionSummary() {
            const count = selectedInvoicesForQuote.length;
            const total = selectedInvoicesForQuote.reduce((sum, id) => {
                const invoice = availableInvoices.find(inv => inv.id === id);
                return sum + (invoice ? invoice.monto : 0);
            }, 0);

            document.getElementById('selectedInvoicesCount').textContent = count;
            document.getElementById('selectedInvoicesTotal').textContent = `$${total.toLocaleString()}`;
        }

        function calculateAdvancedQuotation() {
            const totalAmount = selectedInvoicesForQuote.reduce((sum, id) => {
                const invoice = availableInvoices.find(inv => inv.id === id);
                return sum + (invoice ? invoice.monto : 0);
            }, 0);

            if (totalAmount === 0) {
                // Reset all values
                document.getElementById('summaryTotal').textContent = '$0';
                document.getElementById('summaryAdelanto').textContent = '$0';
                document.getElementById('summaryRetencion').textContent = '$0';
                document.getElementById('summaryComision').textContent = '$0';
                document.getElementById('summaryNeto').textContent = '$0';
                document.getElementById('summaryCAT').textContent = '0%';
                document.getElementById('paymentScheduleTable').innerHTML = '';
                return;
            }

            const plazo = parseFloat(document.getElementById('quotePlazo').value) || 30;
            const adelanto = parseFloat(document.getElementById('quoteAdelanto').value) || 80;
            const retencion = parseFloat(document.getElementById('quoteRetencion').value) || 15;
            const tasa = parseFloat(document.getElementById('quoteTasa').value) || 24;
            const comision = parseFloat(document.getElementById('quoteComision').value) || 3;

            const montoAdelanto = totalAmount * (adelanto / 100);
            const montoRetencion = totalAmount * (retencion / 100);
            const montoComision = totalAmount * (comision / 100);
            const netoRecibido = montoAdelanto - montoComision;

            // Cálculo del CAT
            const tasaMensual = tasa / 100 / 12;
            const periodos = plazo / 30;
            const cat = ((Math.pow(1 + tasaMensual, 12) - 1) * 100) + comision;

            // Update summary
            document.getElementById('summaryTotal').textContent = `$${totalAmount.toLocaleString()}`;
            document.getElementById('summaryAdelanto').textContent = `$${montoAdelanto.toLocaleString()}`;
            document.getElementById('summaryRetencion').textContent = `$${montoRetencion.toLocaleString()}`;
            document.getElementById('summaryComision').textContent = `$${montoComision.toLocaleString()}`;
            document.getElementById('summaryNeto').textContent = `$${netoRecibido.toLocaleString()}`;
            document.getElementById('summaryCAT').textContent = `${cat.toFixed(2)}%`;

            // Generate payment schedule
            const paymentTable = document.getElementById('paymentScheduleTable');
            const fechaPago1 = new Date();
            const fechaPago2 = new Date(Date.now() + plazo * 24 * 60 * 60 * 1000);

            paymentTable.innerHTML = `
                <tr>
                    <td>1</td>
                    <td>${fechaPago1.toLocaleDateString('es-MX')}</td>
                    <td class="text-success fw-bold">$${montoAdelanto.toLocaleString()}</td>
                </tr>
                <tr>
                    <td>2</td>
                    <td>${fechaPago2.toLocaleDateString('es-MX')}</td>
                    <td class="text-warning fw-bold">$${montoRetencion.toLocaleString()}</td>
                </tr>
            `;

            // Store calculation for PDF generation
            window.currentQuotation = {
                totalAmount,
                montoAdelanto,
                montoRetencion,
                montoComision,
                netoRecibido,
                cat: cat.toFixed(2),
                plazo,
                adelanto,
                retencion,
                tasa,
                comision,
                fechaPago1: fechaPago1.toLocaleDateString('es-MX'),
                fechaPago2: fechaPago2.toLocaleDateString('es-MX'),
                selectedInvoices: selectedInvoicesForQuote.map(id => availableInvoices.find(inv => inv.id === id)).filter(Boolean)
            };
        }

        function downloadQuotationPDF() {
            if (!window.currentQuotation || selectedInvoicesForQuote.length === 0) {
                showAlert('Debe seleccionar facturas y calcular la cotización primero', 'warning');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Header
            doc.setFontSize(20);
            doc.setTextColor(30, 58, 138);
            doc.text('TekProvider - Cotización de Factoraje', 20, 30);

            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text(`Fecha: ${new Date().toLocaleDateString('es-MX')}`, 20, 45);
            doc.text(`Cotización No: COT-${Date.now().toString().slice(-6)}`, 20, 55);

            // Invoice details
            doc.setFontSize(14);
            doc.setTextColor(30, 58, 138);
            doc.text('Facturas Incluidas:', 20, 75);

            let yPos = 85;
            window.currentQuotation.selectedInvoices.forEach((invoice, index) => {
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.text(`${invoice.folio} - ${invoice.cliente} - $${invoice.monto.toLocaleString()}`, 25, yPos);
                yPos += 10;
            });

            // Financial summary
            yPos += 10;
            doc.setFontSize(14);
            doc.setTextColor(30, 58, 138);
            doc.text('Resumen Financiero:', 20, yPos);

            yPos += 15;
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text(`Monto Total: $${window.currentQuotation.totalAmount.toLocaleString()}`, 25, yPos);
            yPos += 10;
            doc.text(`Adelanto (${window.currentQuotation.adelanto}%): $${window.currentQuotation.montoAdelanto.toLocaleString()}`, 25, yPos);
            yPos += 10;
            doc.text(`Retención (${window.currentQuotation.retencion}%): $${window.currentQuotation.montoRetencion.toLocaleString()}`, 25, yPos);
            yPos += 10;
            doc.text(`Comisión (${window.currentQuotation.comision}%): $${window.currentQuotation.montoComision.toLocaleString()}`, 25, yPos);
            yPos += 10;
            doc.setTextColor(0, 128, 0);
            doc.text(`Neto a Recibir: $${window.currentQuotation.netoRecibido.toLocaleString()}`, 25, yPos);
            yPos += 10;
            doc.setTextColor(255, 0, 0);
            doc.text(`CAT: ${window.currentQuotation.cat}%`, 25, yPos);

            // Payment schedule
            yPos += 20;
            doc.setFontSize(14);
            doc.setTextColor(30, 58, 138);
            doc.text('Tabla de Pagos:', 20, yPos);

            yPos += 15;
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text(`Pago 1 - ${window.currentQuotation.fechaPago1}: $${window.currentQuotation.montoAdelanto.toLocaleString()}`, 25, yPos);
            yPos += 10;
            doc.text(`Pago 2 - ${window.currentQuotation.fechaPago2}: $${window.currentQuotation.montoRetencion.toLocaleString()}`, 25, yPos);

            // Footer
            yPos += 30;
            doc.setFontSize(10);
            doc.setTextColor(128, 128, 128);
            doc.text('Este documento es una cotización preliminar sujeta a aprobación.', 20, yPos);
            doc.text('TekProvider - Portal de Proveedores', 20, yPos + 10);

            doc.save(`Cotizacion_Factoraje_${Date.now()}.pdf`);
            showAlert('PDF de cotización descargado exitosamente', 'success');
        }

        function applyAdvancedQuotation() {
            if (selectedInvoicesForQuote.length === 0) {
                showAlert('Debe seleccionar al menos una factura', 'warning');
                return;
            }

            showAlert('Cotización aplicada exitosamente', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('advancedQuotationModal'));
            modal.hide();
        }

        function removeFromRequest(id) {
            const selectedIds = JSON.parse(localStorage.getItem('selectedInvoices') || '[]');
            const updatedIds = selectedIds.filter(selectedId => selectedId != id);
            localStorage.setItem('selectedInvoices', JSON.stringify(updatedIds));
            loadSelectedInvoices();
        }

        function submitRequest() {
            const selectedIds = JSON.parse(localStorage.getItem('selectedInvoices') || '[]');
            
            if (selectedIds.length === 0) {
                showAlert('No hay facturas seleccionadas para enviar a factoraje', 'warning');
                return;
            }
            
            // Generate random request number
            const requestNumber = 'REQ-' + Math.floor(Math.random() * 100000);
            
            showAlert(`Solicitud ${requestNumber} enviada exitosamente`, 'success');
            
            // Clear selected invoices
            localStorage.removeItem('selectedInvoices');
            loadSelectedInvoices();
        }

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadSelectedInvoices();
        });
    </script>
</body>
</html>