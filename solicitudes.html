<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicitudes de Factoraje - TekProvider</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/main.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="wrapper">
        <!-- Sidebar -->
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-building logo"></i>
                <h3>TekProvider</h3>
            </div>
            <ul class="sidebar-nav">
                <li class="nav-item">
                    <a href="dashboard.html" class="nav-link">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="facturas.html" class="nav-link">
                        <i class="fas fa-file-invoice"></i>
                        <span>Mis Facturas</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="solicitudes.html" class="nav-link active">
                        <i class="fas fa-paper-plane"></i>
                        <span>Solicitudes de Factoraje</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="estatus.html" class="nav-link">
                        <i class="fas fa-chart-line"></i>
                        <span>Estatus</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="reportes.html" class="nav-link">
                        <i class="fas fa-chart-bar"></i>
                        <span>Reportes</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="tickets.html" class="nav-link">
                        <i class="fas fa-headset"></i>
                        <span>Mesa de Ayuda</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="perfil.html" class="nav-link">
                        <i class="fas fa-user"></i>
                        <span>Mi Perfil</span>
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <div id="content" class="content">
            <!-- Top Navigation -->
            <nav class="navbar navbar-expand-lg navbar-light">
                <div class="container-fluid">
                    <button type="button" id="sidebarToggle" class="btn btn-outline-primary">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="navbar-nav ms-auto">
                        <div class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user-circle"></i>
                                Admin
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="perfil.html">Mi Perfil</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="logout()">Cerrar Sesión</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- Main Content Area -->
            <div class="main-content">
                <div class="container-fluid">
                    <!-- Header -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h1 class="h2 mb-1">Solicitudes de Factoraje</h1>
                                    <p class="text-muted mb-0">Cotiza y gestiona tus solicitudes de factoraje</p>
                                </div>
                                <button class="btn btn-primary btn-lg" onclick="showQuotationModal()">
                                    <i class="fas fa-calculator me-2"></i>
                                    Cotizador Inteligente
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Facturas disponibles -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-file-invoice me-2 text-primary"></i>
                                Facturas Disponibles para Factoraje
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="availableInvoices"></div>
                            <div id="emptyState" class="text-center py-5" style="display: none;">
                                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No hay facturas para factoraje</h5>
                                <p class="text-muted">Envía facturas desde "Mis Facturas" para poder cotizarlas aquí</p>
                                <a href="facturas.html" class="btn btn-primary">
                                    <i class="fas fa-file-invoice me-2"></i>Ir a Mis Facturas
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal del Cotizador Inteligente -->
    <div class="modal fade" id="quotationModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header bg-gradient-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-calculator me-2"></i>
                        Cotizador Inteligente de Factoraje
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="row h-100">
                        <!-- Panel Izquierdo - Selección de Facturas -->
                        <div class="col-lg-4">
                            <div class="card h-100">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-list-check me-2"></i>
                                        Seleccionar Facturas
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                                            <input type="text" class="form-control" id="searchQuoteInvoices" placeholder="Buscar facturas...">
                                        </div>
                                    </div>
                                    
                                    <div id="invoiceGrid" class="invoice-grid">
                                        <!-- Grid de facturas se carga aquí -->
                                    </div>
                                    
                                    <div class="mt-3">
                                        <div class="card bg-light">
                                            <div class="card-body text-center">
                                                <div class="row">
                                                    <div class="col-6">
                                                        <h4 class="text-primary mb-0" id="selectedQuoteCount">0</h4>
                                                        <small class="text-muted">Facturas</small>
                                                    </div>
                                                    <div class="col-6">
                                                        <h4 class="text-success mb-0" id="selectedQuoteTotal">$0</h4>
                                                        <small class="text-muted">Total</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Panel Central - Parámetros -->
                        <div class="col-lg-4">
                            <div class="card h-100">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="mb-0">
                                        <i class="fas fa-sliders-h me-2"></i>
                                        Parámetros de Cotización
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-12 mb-3">
                                            <label class="form-label">Plazo (días)</label>
                                            <input type="range" class="form-range" id="plazoRange" min="15" max="90" value="30" oninput="updateQuotation()">
                                            <div class="d-flex justify-content-between">
                                                <small>15 días</small>
                                                <strong id="plazoValue">30 días</strong>
                                                <small>90 días</small>
                                            </div>
                                        </div>
                                        
                                        <div class="col-12 mb-3">
                                            <label class="form-label">% Adelanto</label>
                                            <input type="range" class="form-range" id="adelantoRange" min="50" max="95" value="80" oninput="updateQuotation()">
                                            <div class="d-flex justify-content-between">
                                                <small>50%</small>
                                                <strong id="adelantoValue">80%</strong>
                                                <small>95%</small>
                                            </div>
                                        </div>
                                        
                                        <div class="col-12 mb-3">
                                            <label class="form-label">% Retención</label>
                                            <input type="range" class="form-range" id="retencionRange" min="5" max="25" value="15" oninput="updateQuotation()">
                                            <div class="d-flex justify-content-between">
                                                <small>5%</small>
                                                <strong id="retencionValue">15%</strong>
                                                <small>25%</small>
                                            </div>
                                        </div>
                                        
                                        <div class="col-12 mb-3">
                                            <label class="form-label">Tasa Anual (%)</label>
                                            <input type="range" class="form-range" id="tasaRange" min="12" max="36" value="24" step="0.5" oninput="updateQuotation()">
                                            <div class="d-flex justify-content-between">
                                                <small>12%</small>
                                                <strong id="tasaValue">24%</strong>
                                                <small>36%</small>
                                            </div>
                                        </div>
                                        
                                        <div class="col-12 mb-3">
                                            <label class="form-label">% Comisión</label>
                                            <input type="range" class="form-range" id="comisionRange" min="1" max="8" value="3" step="0.1" oninput="updateQuotation()">
                                            <div class="d-flex justify-content-between">
                                                <small>1%</small>
                                                <strong id="comisionValue">3%</strong>
                                                <small>8%</small>
                                            </div>
                                        </div>
                                    </div>

                                    <hr>

                                    <div class="row">
                                        <div class="col-12 mb-3">
                                            <label class="form-label">Cedente</label>
                                            <select class="form-select" id="cedenteSelect">
                                                <option value="Servicios Demo S.A.">Servicios Demo S.A.</option>
                                                <option value="Nestlé México">Nestlé México</option>
                                                <option value="Coca Cola">Coca Cola</option>
                                                <option value="Walmart">Walmart</option>
                                            </select>
                                        </div>
                                        <div class="col-12 mb-3">
                                            <label class="form-label">Pagador</label>
                                            <select class="form-select" id="pagadorSelect">
                                                <option value="Servicios Demo S.A.">Servicios Demo S.A.</option>
                                                <option value="Nestlé México">Nestlé México</option>
                                                <option value="Coca Cola">Coca Cola</option>
                                                <option value="Walmart">Walmart</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Panel Derecho - Resultados -->
                        <div class="col-lg-4">
                            <div class="card h-100">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-chart-line me-2"></i>
                                        Resumen de Cotización
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <!-- Monto Total -->
                                    <div class="text-center mb-4">
                                        <div class="bg-primary text-white p-3 rounded-3">
                                            <h3 class="mb-0" id="quoteTotalAmount">$0</h3>
                                            <small>Monto Total Facturas</small>
                                        </div>
                                    </div>

                                    <!-- Cálculos -->
                                    <div class="row g-2 mb-4">
                                        <div class="col-6">
                                            <div class="bg-success text-white p-2 rounded text-center">
                                                <h5 class="mb-0" id="quoteAdvance">$0</h5>
                                                <small>Adelanto</small>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="bg-warning text-dark p-2 rounded text-center">
                                                <h5 class="mb-0" id="quoteRetention">$0</h5>
                                                <small>Retención</small>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="bg-danger text-white p-2 rounded text-center">
                                                <h5 class="mb-0" id="quoteCommission">$0</h5>
                                                <small>Comisión</small>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="bg-info text-white p-2 rounded text-center">
                                                <h5 class="mb-0" id="quoteCAT">0%</h5>
                                                <small>CAT</small>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Neto a Recibir -->
                                    <div class="text-center mb-4">
                                        <div class="bg-dark text-white p-3 rounded-3">
                                            <h3 class="mb-0" id="quoteNetAmount">$0</h3>
                                            <small>Neto a Recibir</small>
                                        </div>
                                    </div>

                                    <!-- Tabla de Pagos -->
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">
                                                <i class="fas fa-calendar-alt me-2"></i>
                                                Cronograma de Pagos
                                            </h6>
                                        </div>
                                        <div class="card-body p-0">
                                            <div class="table-responsive">
                                                <table class="table table-sm mb-0">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th>Pago</th>
                                                            <th>Fecha</th>
                                                            <th>Monto</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="paymentSchedule">
                                                        <!-- Cronograma se genera aquí -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Análisis de Riesgo -->
                                    <div class="mt-3">
                                        <div class="card border-0 bg-light">
                                            <div class="card-body p-3">
                                                <h6 class="mb-2">
                                                    <i class="fas fa-shield-alt me-2 text-success"></i>
                                                    Análisis de Riesgo
                                                </h6>
                                                <div class="d-flex justify-content-between">
                                                    <span>Calificación:</span>
                                                    <span class="badge bg-success" id="riskRating">Bajo Riesgo</span>
                                                </div>
                                                <div class="progress mt-2" style="height: 8px;">
                                                    <div class="progress-bar bg-success" id="riskBar" style="width: 85%"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-danger" onclick="downloadPDF()">
                        <i class="fas fa-file-pdf me-2"></i>Descargar PDF
                    </button>
                    <button type="button" class="btn btn-success" onclick="applyQuotation()">
                        <i class="fas fa-check me-2"></i>Aplicar Cotización
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/main.js"></script>
    <script>
        let availableInvoices = [];
        let selectedForQuote = [];
        let currentQuotation = {};

        document.addEventListener('DOMContentLoaded', function() {
            loadAvailableInvoices();
        });

        function loadAvailableInvoices() {
            const stored = localStorage.getItem('facturasParaFactoraje');
            availableInvoices = stored ? JSON.parse(stored) : [];
            
            const container = document.getElementById('availableInvoices');
            const emptyState = document.getElementById('emptyState');
            
            if (availableInvoices.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            container.style.display = 'block';
            emptyState.style.display = 'none';
            
            let html = '<div class="row">';
            availableInvoices.forEach(invoice => {
                html += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card invoice-card h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0">${invoice.folio}</h6>
                                    <span class="badge ${getStatusBadge(invoice.estatus)}">${invoice.estatus}</span>
                                </div>
                                <p class="card-text text-muted mb-2">${invoice.cliente}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="h5 text-success mb-0">$${invoice.monto.toLocaleString()}</span>
                                    <small class="text-muted">${formatDate(invoice.fechaVencimiento)}</small>
                                </div>
                                <div class="mt-2">
                                    <span class="badge ${invoice.tipoOperacion === 'Proveedor' ? 'bg-info' : 'bg-warning'} me-1">${invoice.tipoOperacion}</span>
                                    <span class="badge ${invoice.recurso === 'Con Recurso' ? 'bg-danger' : 'bg-success'}">${invoice.recurso}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function showQuotationModal() {
            if (availableInvoices.length === 0) {
                showAlert('No hay facturas disponibles para cotizar. Envía facturas desde "Mis Facturas" primero.', 'warning');
                return;
            }
            
            loadInvoiceGrid();
            const modal = new bootstrap.Modal(document.getElementById('quotationModal'));
            modal.show();
        }

        function loadInvoiceGrid() {
            const grid = document.getElementById('invoiceGrid');
            grid.innerHTML = '';

            availableInvoices.forEach(invoice => {
                const isSelected = selectedForQuote.includes(invoice.id);
                const card = document.createElement('div');
                card.className = `invoice-grid-item ${isSelected ? 'selected' : ''}`;
                card.onclick = () => toggleInvoiceSelection(invoice.id);
                
                card.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-grow-1">
                            <div class="fw-bold">${invoice.folio}</div>
                            <div class="text-muted small">${invoice.cliente}</div>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold text-success">$${invoice.monto.toLocaleString()}</div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" ${isSelected ? 'checked' : ''}>
                            </div>
                        </div>
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }

        function toggleInvoiceSelection(invoiceId) {
            const index = selectedForQuote.indexOf(invoiceId);
            if (index > -1) {
                selectedForQuote.splice(index, 1);
            } else {
                selectedForQuote.push(invoiceId);
            }
            
            loadInvoiceGrid();
            updateQuoteSelection();
            updateQuotation();
        }

        function updateQuoteSelection() {
            const count = selectedForQuote.length;
            const total = selectedForQuote.reduce((sum, id) => {
                const invoice = availableInvoices.find(inv => inv.id === id);
                return sum + (invoice ? invoice.monto : 0);
            }, 0);

            document.getElementById('selectedQuoteCount').textContent = count;
            document.getElementById('selectedQuoteTotal').textContent = `$${total.toLocaleString()}`;
        }

        function updateQuotation() {
            // Actualizar valores de los sliders
            const plazo = document.getElementById('plazoRange').value;
            const adelanto = document.getElementById('adelantoRange').value;
            const retencion = document.getElementById('retencionRange').value;
            const tasa = document.getElementById('tasaRange').value;
            const comision = document.getElementById('comisionRange').value;

            document.getElementById('plazoValue').textContent = `${plazo} días`;
            document.getElementById('adelantoValue').textContent = `${adelanto}%`;
            document.getElementById('retencionValue').textContent = `${retencion}%`;
            document.getElementById('tasaValue').textContent = `${tasa}%`;
            document.getElementById('comisionValue').textContent = `${comision}%`;

            // Calcular totales
            const totalAmount = selectedForQuote.reduce((sum, id) => {
                const invoice = availableInvoices.find(inv => inv.id === id);
                return sum + (invoice ? invoice.monto : 0);
            }, 0);

            if (totalAmount === 0) {
                resetQuotationDisplay();
                return;
            }

            const advanceAmount = totalAmount * (adelanto / 100);
            const retentionAmount = totalAmount * (retencion / 100);
            const commissionAmount = totalAmount * (comision / 100);
            const netAmount = advanceAmount - commissionAmount;

            // Calcular CAT
            const monthlyRate = tasa / 100 / 12;
            const cat = ((Math.pow(1 + monthlyRate, 12) - 1) * 100) + parseFloat(comision);

            // Actualizar display
            document.getElementById('quoteTotalAmount').textContent = `$${totalAmount.toLocaleString()}`;
            document.getElementById('quoteAdvance').textContent = `$${advanceAmount.toLocaleString()}`;
            document.getElementById('quoteRetention').textContent = `$${retentionAmount.toLocaleString()}`;
            document.getElementById('quoteCommission').textContent = `$${commissionAmount.toLocaleString()}`;
            document.getElementById('quoteNetAmount').textContent = `$${netAmount.toLocaleString()}`;
            document.getElementById('quoteCAT').textContent = `${cat.toFixed(2)}%`;

            // Generar cronograma de pagos
            generatePaymentSchedule(plazo, advanceAmount, retentionAmount);

            // Guardar cotización actual
            currentQuotation = {
                totalAmount,
                advanceAmount,
                retentionAmount,
                commissionAmount,
                netAmount,
                cat: cat.toFixed(2),
                plazo,
                adelanto,
                retencion,
                tasa,
                comision,
                selectedInvoices: selectedForQuote.map(id => availableInvoices.find(inv => inv.id === id)).filter(Boolean)
            };
        }

        function generatePaymentSchedule(plazo, advanceAmount, retentionAmount) {
            const tbody = document.getElementById('paymentSchedule');
            const today = new Date();
            const futureDate = new Date(today.getTime() + plazo * 24 * 60 * 60 * 1000);

            tbody.innerHTML = `
                <tr>
                    <td><span class="badge bg-success">1</span></td>
                    <td>${today.toLocaleDateString('es-MX')}</td>
                    <td class="fw-bold text-success">$${advanceAmount.toLocaleString()}</td>
                </tr>
                <tr>
                    <td><span class="badge bg-warning">2</span></td>
                    <td>${futureDate.toLocaleDateString('es-MX')}</td>
                    <td class="fw-bold text-warning">$${retentionAmount.toLocaleString()}</td>
                </tr>
            `;
        }

        function resetQuotationDisplay() {
            document.getElementById('quoteTotalAmount').textContent = '$0';
            document.getElementById('quoteAdvance').textContent = '$0';
            document.getElementById('quoteRetention').textContent = '$0';
            document.getElementById('quoteCommission').textContent = '$0';
            document.getElementById('quoteNetAmount').textContent = '$0';
            document.getElementById('quoteCAT').textContent = '0%';
            document.getElementById('paymentSchedule').innerHTML = '';
        }

        function downloadPDF() {
            if (selectedForQuote.length === 0) {
                showAlert('Debe seleccionar facturas para generar el PDF', 'warning');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Header
            doc.setFontSize(20);
            doc.setTextColor(30, 58, 138);
            doc.text('TekProvider - Cotización de Factoraje', 20, 30);

            // Información general
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text(`Fecha: ${new Date().toLocaleDateString('es-MX')}`, 20, 50);
            doc.text(`Cotización No: COT-${Date.now().toString().slice(-6)}`, 20, 60);
            doc.text(`Cliente: Servicios Demo S.A.`, 20, 70);

            // Facturas incluidas
            doc.setFontSize(14);
            doc.setTextColor(30, 58, 138);
            doc.text('Facturas Incluidas:', 20, 90);

            let yPos = 100;
            currentQuotation.selectedInvoices.forEach((invoice, index) => {
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.text(`${index + 1}. ${invoice.folio} - ${invoice.cliente} - $${invoice.monto.toLocaleString()}`, 25, yPos);
                yPos += 8;
            });

            // Resumen financiero
            yPos += 10;
            doc.setFontSize(14);
            doc.setTextColor(30, 58, 138);
            doc.text('Resumen Financiero:', 20, yPos);

            yPos += 15;
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text(`Monto Total: $${currentQuotation.totalAmount.toLocaleString()}`, 25, yPos);
            yPos += 10;
            doc.text(`Plazo: ${currentQuotation.plazo} días`, 25, yPos);
            yPos += 10;
            doc.text(`Adelanto (${currentQuotation.adelanto}%): $${currentQuotation.advanceAmount.toLocaleString()}`, 25, yPos);
            yPos += 10;
            doc.text(`Retención (${currentQuotation.retencion}%): $${currentQuotation.retentionAmount.toLocaleString()}`, 25, yPos);
            yPos += 10;
            doc.text(`Comisión (${currentQuotation.comision}%): $${currentQuotation.commissionAmount.toLocaleString()}`, 25, yPos);
            yPos += 10;
            doc.setTextColor(0, 128, 0);
            doc.text(`Neto a Recibir: $${currentQuotation.netAmount.toLocaleString()}`, 25, yPos);
            yPos += 10;
            doc.setTextColor(255, 0, 0);
            doc.text(`CAT: ${currentQuotation.cat}%`, 25, yPos);

            // Cronograma de pagos
            yPos += 20;
            doc.setFontSize(14);
            doc.setTextColor(30, 58, 138);
            doc.text('Cronograma de Pagos:', 20, yPos);

            yPos += 15;
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            const today = new Date();
            const futureDate = new Date(today.getTime() + currentQuotation.plazo * 24 * 60 * 60 * 1000);
            doc.text(`Pago 1 - ${today.toLocaleDateString('es-MX')}: $${currentQuotation.advanceAmount.toLocaleString()} (Adelanto)`, 25, yPos);
            yPos += 10;
            doc.text(`Pago 2 - ${futureDate.toLocaleDateString('es-MX')}: $${currentQuotation.retentionAmount.toLocaleString()} (Retención)`, 25, yPos);

            // Footer
            yPos += 30;
            doc.setFontSize(10);
            doc.setTextColor(128, 128, 128);
            doc.text('Esta cotización es válida por 7 días hábiles.', 20, yPos);
            doc.text('TekProvider - Portal de Proveedores | www.tekprovider.com', 20, yPos + 10);

            doc.save(`Cotizacion_Factoraje_${Date.now()}.pdf`);
            showAlert('PDF de cotización descargado exitosamente', 'success');
        }

        function applyQuotation() {
            if (selectedForQuote.length === 0) {
                showAlert('Debe seleccionar facturas para aplicar la cotización', 'warning');
                return;
            }

            // Simular envío de solicitud
            const requestNumber = `REQ-${Date.now().toString().slice(-6)}`;
            
            // Limpiar facturas procesadas
            availableInvoices = availableInvoices.filter(inv => !selectedForQuote.includes(inv.id));
            localStorage.setItem('facturasParaFactoraje', JSON.stringify(availableInvoices));
            
            selectedForQuote = [];
            loadAvailableInvoices();

            const modal = bootstrap.Modal.getInstance(document.getElementById('quotationModal'));
            modal.hide();

            showAlert(`Solicitud ${requestNumber} enviada exitosamente con ${currentQuotation.selectedInvoices.length} facturas`, 'success');
        }

        function getStatusBadge(status) {
            switch(status) {
                case 'Emitida': return 'bg-primary';
                case 'Pagada': return 'bg-success';
                case 'Vencida': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('es-MX');
        }
    </script>
</body>
</html>